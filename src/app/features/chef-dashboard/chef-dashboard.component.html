<div class="chef-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <mat-icon class="header-icon">supervisor_account</mat-icon>
      <div>
        <h1>Tableau de Bord - Chef de Service</h1>
        <p *ngIf="departmentService">{{ departmentService.nom }}</p>
        <p *ngIf="currentChef" class="chef-name">
          {{ currentChef.prenom }} {{ currentChef.nom }}
        </p>
      </div>
    </div>
    <button mat-raised-button color="primary" (click)="loadDepartmentTasks()">
      <mat-icon>refresh</mat-icon>
      Actualiser
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <p>Chargement des données du département...</p>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid" *ngIf="!isLoading">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #e3f2fd;">
          <mat-icon style="color: #1976d2;">assignment</mat-icon>
        </div>
        <div class="stat-details">
          <h3>{{ stats.totalTasks }}</h3>
          <p>Total Tâches</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #e8f5e9;">
          <mat-icon style="color: #4caf50;">check_circle</mat-icon>
        </div>
        <div class="stat-details">
          <h3>{{ stats.completedTasks }}</h3>
          <p>Tâches Validées</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #fff3e0;">
          <mat-icon style="color: #ff9800;">hourglass_empty</mat-icon>
        </div>
        <div class="stat-details">
          <h3>{{ stats.pendingTasks }}</h3>
          <p>En Attente</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #ffebee;">
          <mat-icon style="color: #f44336;">warning</mat-icon>
        </div>
        <div class="stat-details">
          <h3>{{ stats.overdueTasks }}</h3>
          <p>En Retard</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #f3e5f5;">
          <mat-icon style="color: #9c27b0;">trending_up</mat-icon>
        </div>
        <div class="stat-details">
          <h3>{{ stats.completionRate }}%</h3>
          <p>Taux de Complétion</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background-color: #fce4ec;">
          <mat-icon style="color: #e91e63;">priority_high</mat-icon>
        </div>
        <div class="stat-details">
          <h3>{{ stats.urgentTasks }}</h3>
          <p>Tâches Urgentes</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Charts Section -->
  <div class="charts-grid" *ngIf="!isLoading">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Statut des Tâches</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart
            [data]="taskStatusChart"
            [options]="taskStatusChartOptions"
            type="doughnut">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>Charge de Travail par Employé</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart
            [data]="employeeWorkloadChart"
            [options]="employeeWorkloadChartOptions"
            type="bar">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Tasks Table -->
  <mat-card class="tasks-card" *ngIf="!isLoading">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>format_list_bulleted</mat-icon>
        Tâches du Département ({{ departmentTasks.length }})
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="departmentTasks" class="tasks-table">
        
       <!-- Change intitule to titre -->
<ng-container matColumnDef="titre">
  <th mat-header-cell *matHeaderCellDef>Tâche</th>
  <td mat-cell *matCellDef="let task">
    <div class="task-name">
      <strong>{{ task.titre }}</strong>
      <mat-icon *ngIf="task.critique" 
                color="warn" 
                matTooltip="Tâche critique"
                class="critical-icon">
        error
      </mat-icon>
    </div>
  </td>
</ng-container>

<!-- Update responsable column -->
<ng-container matColumnDef="responsable">
  <th mat-header-cell *matHeaderCellDef>Responsable</th>
  <td mat-cell *matCellDef="let task">
    <div class="employee-info">
      <mat-icon>person</mat-icon>
      {{ getResponsableName(task) }}
    </div>
  </td>
</ng-container>

<!-- Update echeance to use date_fin -->
<ng-container matColumnDef="echeance">
  <th mat-header-cell *matHeaderCellDef>Échéance</th>
  <td mat-cell *matCellDef="let task">
    <div [class.overdue]="isTaskOverdue(task)">
      <mat-icon *ngIf="isTaskOverdue(task)">warning</mat-icon>
      {{ formatDate(task.date_fin) }}
    </div>
  </td>
</ng-container>

        <!-- Priority Column -->
        <ng-container matColumnDef="priorite">
          <th mat-header-cell *matHeaderCellDef>Priorité</th>
          <td mat-cell *matCellDef="let task">
            <mat-chip [color]="getTaskPriorityColor(task.priorite)" selected>
              {{ task.priorite }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- State Column -->
        <ng-container matColumnDef="etat">
          <th mat-header-cell *matHeaderCellDef>État</th>
          <td mat-cell *matCellDef="let task">
            <mat-chip [color]="getTaskStateColor(task.etat)" selected>
              {{ task.etat }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let task">
            <button mat-icon-button 
                    color="primary"
                    (click)="openApprovalDialog(task)"
                    matTooltip="Approuver/Rejeter"
                    [disabled]="task.etat === 'VALIDEE'">
              <mat-icon>check_circle</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <div *ngIf="departmentTasks.length === 0" class="no-tasks">
        <mat-icon>inbox</mat-icon>
        <p>Aucune tâche assignée à votre département</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>